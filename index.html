<html>
<head>
    <meta charset="UTF-8">
    <link href="lib/bootstrap.min.css" rel="stylesheet">
    <link href="css/typeahead.css" rel="stylesheet">
    <script src="lib/underscore-min.js" type="text/javascript"></script>
    <script src="lib/jquery-2.1.3.min.js" type="text/javascript"></script>
    <script src="typeahead.js/dist/typeahead.bundle.js" type="text/javascript"></script>
    <script src="ldf-client-browser.js"></script>
    <script src="lib/rdf-ext.min.js"></script>
    <script src="matcher.js" type="text/javascript"></script>
    <script src="src/uduvudu.js" type="text/javascript"></script>
</head>
<body>
    <div class="container" style="width: 560px">
    <div id="intro">
<h1>UDUVUDU &ndash; DBpedia Viewer</h1>
This proof of concept application shows <a href="https://github.com/uduvudu/uduvudu/">UDUVUDU</a> rendering entries from <a href="http://dbpedia.org">DBpedia</a>. <small>It further makes uses of <a href="http://linkeddatafragments.org/">linked data fragments</a>, <a href="https://github.com/zazukoians/rdf-ext">rdf-ext</a> and also <a href="http://getbootstrap.com/">bootstrap</a> and <a href="https://twitter.github.io/typeahead.js/">typeaheadjs</a>.</small>
       <br>
Please start searching for an entry in DBpedia by typing at least 3 letters. To confirm your decision select a proposition in the list.
    </div>
        <div id="chooser">
            <br>
            <form class="form-inline" role="form">
            <input class="typeahead form-control" type="text" placeholder="search ..." autofocus>
            </form> 
            <!--
            <form class="form-inline" role="form">
                <select id="selectSource" class="form-control">
                    <option>Select a sample RDF URI</option>
                    <option data-res="http://dbpedia.org/resource/Bern">http://dbpedia.org/data/Bern.ttl</option>
                    <option data-res="http://dbpedia.org/resource/Fribourg">http://dbpedia.org/data/Fribourg.ttl</option>
                </select>
            </form> 
            -->
        </div>
        <div id="main">
        </div>
        <div id="footer">

        </div>
    </div>
    <div id="visualizer">
    </div>
    <script type="text/javascript">

        // typeahead source
        var dbpedia = function() {
          return function findMatches(q, cb) {
            $.ajax(
                "http://lookup.dbpedia.org/api/search/PrefixSearch?QueryClass=&MaxHits=15&QueryString="+q,
                {dataType: "json"}
            ).done(function(data) {
                cb(_.sortBy(_.sortBy(data.results, function(b){return b.label.length}),function(s){return -s.label.search(new RegExp('^'+q,'i'))}));
            });
          };
        };

        // initialize type ahead
        $('#chooser .typeahead').typeahead({
          hint: true,
          autoselect: true,
          highlight: true,
          minLength: 2
        },
        {
          name: 'dbpedia',
          displayKey: 'label',
          source: dbpedia()
        });

        // prepare visualizer templates for uduvudu
        $("#visualizer").load("visualizer.html");

        // helper to decipher the get query
        function getParameterByName(name) {
            name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
            var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
                results = regex.exec(location.search);
            return results == null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
        }

        function loadFromSource(source, resource) {
            $("#main").html('<div class="alert alert-info"><button type="button" class="close" data-dismiss="alert">&times;</button> <strong>Loading</strong> '+source+' is being loaded ...</div>');

            ldf.Logger.setLevel('warning');
            var fragmentsClient = new ldf.FragmentsClient('http://fragments.dbpedia.org/2014/en');
            var ldfquery = 'CONSTRUCT { <'+source+'> ?p ?o. ?o <http://www.w3.org/2000/01/rdf-schema#label> ?l} WHERE {<'+source+'> ?p ?o. OPTIONAL {?o <http://www.w3.org/2000/01/rdf-schema#label> ?l.}} LIMIT 100000';
            //var ldfquery = 'CONSTRUCT { <'+source+'> ?p ?o.} WHERE {<'+source+'> ?p ?o.} LIMIT 10000';
            results = new ldf.SparqlIterator(ldfquery, { fragmentsClient: fragmentsClient});
            var rdfstring = '';

            //write back to string, to get reparsed by n3 again, not perfect
            var writer = new N3.Writer({ write: function (chunk, encoding, done) {
               rdfstring = rdfstring + chunk; 
               done && done();
            }}, {});
            results.on('data', function (triple) { writer.addTriple(triple); })
                   .on('end',  function () { writer.end();

            	$("#main").html('<div class="alert alert-info"><button type="button" class="close" data-dismiss="alert">&times;</button> <strong>Processing</strong> '+source+' is being processed ...</div>');

                rdf.parseTurtle(rdfstring, function(graph, error){
                    if (error == null) {
                        $("#main").html(uduvudu.process(graph, source));
                    } else {
                        console.log(error, rdfstring);
                    }; 
                });
        });

        };

        // if uri is specified in title get it
        var uri = getParameterByName('res');
        if (uri != '') {
            loadFromSource(uri, uri);
            }

        $('#chooser .typeahead').on('typeahead:selected', function (event, d) {
	    var uri = d.uri;
            loadFromSource(uri, d.uri);
        });

        $('#setSource').on('keyup', function() {
            loadFromSource(this.value, $('#setResource').val());
        });

        $('#setResource').on('keyup', function() {
            loadFromSource($('#setSource').val(), this.value);
        });

        $('#selectSource').on('change', function(event) {
            loadFromSource(this.value, event.target.selectedOptions[0].attributes['data-res'].nodeValue);
        });
    </script>
</body>
</html>
